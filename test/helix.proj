<Project DefaultTargets="Test">

  <!-- Version included until we get global.json generation to support this SDK. -->
  <Sdk Name="Microsoft.DotNet.Helix.Sdk" Version="1.0.0-beta.18575.1" />

  <UsingTask TaskName="CreateXUnitWorkItems " AssemblyFile="C:\Users\haok\.nuget\packages\microsoft.dotnet.helix.sdk\1.0.0-beta.18565.5\tools\netcoreapp2.1\Microsoft.DotNet.Helix.Sdk.dll"/>

  <Target Name="Gather" BeforeTargets="Test">

    <ItemGroup>
      <ProjectsToTest Include="$(ProjectsToTest)" />
    </ItemGroup>

    <MSBuild Projects="@(ProjectsToTest)"
              Targets="CreateTestPayload"
              BuildInParallel="true">
      <Output TaskParameter="TargetOutputs" ItemName="TestPayload" />
    </MSBuild>
    <ItemGroup>
      <!-- <XUnitProjects Include="%(TestPayload.Identity)" /> -->
      <XUnitProjects Include="C:\Github\Extensions\src\Shared\test\Microsoft.Extensions.Sources.Tests.csproj"
        PublishDirectory="C:\Github\Extensions\src\Shared\test\bin\Debug\net461\publish"
        TargetPath="C:\Github\Extensions\src\Shared\test\bin\Debug\net461\publish\Microsoft.Extensions.Sources.Tests.dll"
        RuntimeTargetFramework="net461"
      />
      <HelixCorrelationPayload Include="xunit-runner">
        <Uri>https://api.nuget.org/v3-flatcontainer/xunit.runner.console/2.4.1/xunit.runner.console.2.4.1.nupkg</Uri>
     </HelixCorrelationPayload>

    </ItemGroup>
    
    <CreateXUnitWorkItems XUnitProjects="@(XUnitProjects)" IsPosixShell="false">
      <Output TaskParameter="XUnitWorkItems" ItemName="HelixWorkItem"/>
    </CreateXUnitWorkItems>

  </Target>

  <PropertyGroup>
    <HelixSource>pr/aspnet/extensions</HelixSource>
    <HelixType>ci</HelixType>
    <!-- TODO: use package version -->
    <HelixBuild>$([System.DateTime]::Now.ToString(yyyyMMdd-hhmmss))</HelixBuild>
    <WaitForWorkItemCompletion>false</WaitForWorkItemCompletion>
    <!-- TODO: ask for ability to specify both cli/sdk payload uris -->
    <IncludeDotNetCli>true</IncludeDotNetCli>
    <DotNetCliPackageType>sdk</DotNetCliPackageType>

    <!--<HelixTargetQueues Condition="'$(TestPlatform)' == 'Windows10.x64'">Windows.10.Amd64.Open</HelixTargetQueues>-->
    <HelixTargetQueues>Windows.10.Amd64.Open</HelixTargetQueues>
    <!-- <HelixTargetQueues>Windows.10.Amd64.Open;Ubuntu.1604.Amd64.Open</HelixTargetQueues> -->
    
    <!--
      'true' to enable the xunit reporter. Default 'false'
      The xunit reporter will report test results from a test results
      xml file found in the work item working directory.
      The following file names are accepted:
        testResults.xml
        test-results.xml
        test_results.xml
    -->
    <EnableXUnitReporter>true</EnableXUnitReporter>

  </PropertyGroup>
</Project>